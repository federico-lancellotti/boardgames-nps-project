---
title: "survival_1"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
  pdf_document: default
---

# Libraries and Dataset

```{r}
setwd("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival")

# Loading necessary libraries
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)

# Import the dataset

#SCEGLINE UNO:
# 1 month:
data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_1month.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_1month_2ratings.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_1month_5ratings.csv")
# # 2 months:
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_2months.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_2months_2ratings.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_2months_5ratings.csv")
# # 4 months:
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_4months.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_4months_2ratings.csv")
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_4months_5ratings.csv")
# # quantiles:
# data <- read.csv("C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_quantiles.csv")

View(data)

# Remove zombies
# 1 month:
data <- data[data$time != 31, ]
# # # 2 months:
# data <- data[data$time != 61, ]
# # # 4 months:
# data <- data[data$time != 121, ]
```



# Deaths

1 MONTH (Const ratings): deaths_1 #20221; zombies_1 #352

1 MONTH (ratings <=2): deaths_1_2 #8311; zombies_1_2 #305

1 MONTH (ratings <=5): deaths_1_5 #3595; zombies_1_5 #132



2 MONTHS (Const ratings): deaths_2 #17227; zombies_2 #263

2 MONTHS (ratings <=2): deaths_2_2 #8069; zombies_2_2 #326

2 MONTHS (ratings <=5): deaths_2_5 #3558; zombies_2_5 #138



4 MONTHS (Const ratings): deaths_4 #13048; zombies_4 #145

4 MONTHS (ratings <=2): deaths_4_2 #7767; zombies_4_2 #314

4 MONTHS (ratings <=5): deaths_4_5 #3490; zombies_4_5 #137



QUANTILES:
714 + 5 to remove




# Initial analysis 

```{r}
# Initial analysis
str(data$id) #check that id is a factor
data$id=as.factor(data$id)
data$status_fact=factor(data$status, labels = (c('Censor', 'Event'))) #=deltai
data_subs = head(data)

#Plot:
ggplot(data=data_subs,aes(x=id,y=time)) + 
  geom_bar(stat='identity',width=0.2) +
  geom_point(aes(color=status_fact,shape=status_fact),size=6) +
  coord_flip()




# Survival object
head(Surv(time=data$time, event=data$status==2))
```






# KAPLAN-MEIER ESTIMATOR

```{r}
# KAPLAN-MEIER ESTIMATOR FOR SURVIVAL CURVES
fit=survfit(Surv(time, status==2) ~1, data=data)
summary(fit)
kable(head(tidy(fit),20))

surv_median(fit)

#Plots:
#1)
plot(fit, conf.int = T, xlab='Time [days]', ylab = 'Survival Probability', col='skyblue',
     main="Kaplan-Meier Curve for Board Games Survival")

#2)
ggsurvplot(fit, data=data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=365,
           title="Kaplan-Meier Curve for Board Games Survival", xlab="Time [days]")
```


```{r}
## Cumulative Failure Probability
cumulative_incidence=1-fit$surv

#Plot:
ggsurvplot(fit, data=data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=365,
           fun='event',
           title="Cumulative Incidence Curve for Board Games Survival", xlab="Time [days]")
```


```{r}
## Hazard function
H=fit$cumhaz

#Plot:
ggsurvplot(fit, data=data,
           risk.table = TRUE, # Add risk table
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=365,
           fun='cumhaz',
           title="Cumulative Hazard Curve for Board Games Survival",
           xlab="Time [days]")
```




# KAPLAN-MEIER CURVES FOR CATEGORIES

## 1)Economic

```{r}
#1) Economic:
data$id=as.factor(data$id)
data$Economic_fact=factor(data$Economic, labels = (c('Non-Economic', 'Economic')))

fit.economic=survfit(Surv(time, status) ~ Economic_fact, data=data)

#Plot:
ggsurvplot(fit.economic, data=data, conf.int = T,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=365,
           legend.labs=c("Non-Economic","Economic"), legend.title="Category",  
           palette=c("darkblue","cyan3"), 
           title="Kaplan-Meier Curves by Economic-Category for Board Games Survival",
           xlab="Time [days]") 
```


## 2) All the categories

```{r}
#2) All the categories:
columns_of_interest <- colnames(data)[17:100]
plot_list=list()
for (col in columns_of_interest) {
  
  data[[paste0(col, "_fact")]] = factor(data[[col]], labels = c('No', 'Yes'))
  covariate=data[,ncol(data)]
  fit = survfit(Surv(time, status) ~ covariate, data = data)
  
  # Plot
  plot=ggsurvplot(fit, data = data, conf.int = TRUE,
             risk.table = TRUE, risk.table.col = "strata",
             surv.median.line = "hv", ggtheme = theme_bw(),
             break.time.by = 365,
             legend.labs = c("No", "Yes"), legend.title = "Category",
             palette = c("darkblue", "cyan3"),
             title = paste("Kaplan-Meier Curves for", col),
             xlab = "Time [days]")
  plot_list[[col]] = plot
}

length(plot_list) #84

pdf("survival_plot_for_all_categories.pdf")
for (i in seq_along(plot_list)) {
  print(plot_list[[i]])
}
dev.off()
file.rename("survival_plot_for_all_categories.pdf", "C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/survival_1_cat.pdf")
```

## LOG-RANK TEST

### 1) Economic

```{r}
#A)USUAL WAY: CHI-SQUARE DISTRIBUTION:
#1)Economic:
log_rank_test_economic=survdiff(Surv(time, status) ~ Economic_fact, data=data)
log_rank_test_economic #p= <2e-16 

hazard_ratio_economic = (log_rank_test_economic$obs[1]/log_rank_test_economic$exp[1])/(log_rank_test_economic$obs[2]/log_rank_test_economic$exp[2])
hazard_ratio_economic #1.334743 > 1 --> Being in the Non-Economic category is a risk factor
```

### 2) All the categories

```{r}
#2)All the categories:
for (i in 105:188) {
  covariate=data[,i]
  print(colnames(data)[i])
  log_rank_test= survdiff(Surv(time, status) ~ covariate, data=data)
  print(log_rank_test)
  hazard_ratio = (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[2]/log_rank_test$exp[2])
  print(hazard_ratio)
  
}
```



### PERMUTATIONAL FRAMEWORK
```{r}
permuted_logrank_test = function(category, time, status, iter = 1000) {
  original_logrank_test = survdiff(Surv(time, status) ~ category)
  T0 = original_logrank_test$chisq
  T_stat = numeric(iter)
  for (i in 1:iter) {
    permuted_category = sample(category)
    permuted_logrank_test = survdiff(Surv(time, status) ~ permuted_category)
    T_stat[i] = permuted_logrank_test$chisq
  }
  p_value = sum(T_stat >= T0) / iter
  return(list(TestStatistic = T0, PValue = p_value))
}
for (i in 105:188) {
  covariate=data[,i]
  print(colnames(data)[i])
  result = permuted_logrank_test(covariate, data$time, data$status, iter = 1000)
  cat("Test Statistic:", result$TestStatistic, "\n")
  cat("P-value:", result$PValue, "\n") 
}
```




# COX MODEL

## a) Univariate 

### 1.A) Year
```{r}
#1.A)Year:
cox.year <- coxph(Surv(time, status) ~ Year, data = data)
cox.year 
summary(cox.year)

#Plot (baseline survival function S0(t)):
plot(survfit(cox.year, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()


mfit <- coxph(Surv(time, status) ~ pspline(Year, df=2), data=data)
mfit
plot.new()
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
abline(h=0)
```



### 2.A) Playing_time
```{r}
#2.A)Playing_time:
cox.playingtime <- coxph(Surv(time, status) ~ playingtime, data = data)
cox.playingtime 
summary(cox.playingtime)

#Plot (baseline survival function S0(t)):
plot(survfit(cox.playingtime, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()



mfit <- coxph(Surv(time, status) ~ pspline(playingtime, df=2), data=data)
mfit
plot.new()
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
abline(h=0)
```



### 3.A)
```{r}
#3.A)MaxPlayers:
cox.max_players <- coxph(Surv(time, status) ~ maxplayers, data = data)
cox.max_players
summary(cox.max_players)

#Plot (baseline survival function S0(t)):
plot(survfit(cox.max_players, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()




mfit <- coxph(Surv(time, status) ~ pspline(maxplayers, df=2), data=data)
mfit
plot.new()
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
abline(h=0)
```



### 4.A) Weight
#### linear:
```{r}
cox.weight = coxph(Surv(time, status) ~ weight, data = data)
cox.weight 
summary(cox.weight)

#Plot (baseline survival function S0(t)):
plot(survfit(cox.weight, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()
```


```{r}
# #4.2.A)Weight:
# weight_quadratic = poly(data$weight, degree = 2, raw=FALSE) #no raw
# data$weight <- as.numeric(data$weight)
# sum(is.na(data$weight))
# cox.weight = coxph(Surv(time, status) ~ poly(scale(data$weight), degree = 2, raw=FALSE), data = data)
# cox.weight
# summary(cox.weight)
# 
# #Plot (baseline survival function S0(t)):
# plot(survfit(cox.weight, data=data),
#      col="darkorange2", lwd=2, lty=1,
#      xlab='Time [days]', ylab='Survival Probability',
#      main='Baseline estimated survival probability')
# grid()
```

#### non linear (psline):

```{r}
#splines penalizzate 
##df=2:
mfit <- coxph(Surv(time, status) ~ pspline(weight, df=2), data=data)
mfit
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

ptemp=termplot(mfit, se=TRUE, plot=FALSE)
attributes(ptemp)
ptemp$weight[1:4,]

weightterm=ptemp$weight
center=with(weightterm, y[x==2])
ytemp=weightterm$y + outer(weightterm$se, c(0, -1, 1), '*')
matplot(weightterm$x, exp(ytemp - center), type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")
#matplot(weightterm$x, exp(ytemp - center), log='y', type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")

#plotting smooth terms:
mfit <- coxph(Surv(time, status) ~ pspline(weight, df=3), data=data)
mfit
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
plot(survfit(mfit, data=data), col="darkorange2", lwd=2, lty=1, xlab='Time [days]', ylab='Survival Probability', main='Baseline estimated survival probability')

ptemp=termplot(mfit, se=TRUE, plot=FALSE)
attributes(ptemp)
ptemp$weight[1:4,]

weightterm=ptemp$weight
center=with(weightterm, y[x==2])
ytemp=weightterm$y + outer(weightterm$se, c(0, -1, 1), '*')
matplot(weightterm$x, exp(ytemp - center), type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")
#matplot(weightterm$x, exp(ytemp - center), log='y', type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")


##df=3:
mfit <- coxph(Surv(time, status) ~ pspline(weight, df=3), data=data)
mfit
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

ptemp=termplot(mfit, se=TRUE, plot=FALSE)
attributes(ptemp)
ptemp$weight[1:4,]

weightterm=ptemp$weight
center=with(weightterm, y[x==2])
ytemp=weightterm$y + outer(weightterm$se, c(0, -1, 1), '*')
matplot(weightterm$x, exp(ytemp - center), type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")
#matplot(weightterm$x, exp(ytemp - center), log='y', type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")

#plotting smooth terms:
mfit <- coxph(Surv(time, status) ~ pspline(weight, df=3), data=data)
mfit
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
plot(survfit(mfit, data=data), col="darkorange2", lwd=2, lty=1, xlab='Time [days]', ylab='Survival Probability', main='Baseline estimated survival probability')

ptemp=termplot(mfit, se=TRUE, plot=FALSE)
attributes(ptemp)
ptemp$weight[1:4,]

weightterm=ptemp$weight
center=with(weightterm, y[x==2])
ytemp=weightterm$y + outer(weightterm$se, c(0, -1, 1), '*')
matplot(weightterm$x, exp(ytemp - center), type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")
#matplot(weightterm$x, exp(ytemp - center), log='y', type='l', lty=c(1,2,2), col=1, xlab="weight", ylab="Relative death rate")
```

#### non linear (altre):

```{r}
#bslines, natural splines, restricted cubic splines
library(splines)
library(rms)
cox_weight=coxph(Surv(time, status) ~ bs(weight, df=3), data = data)
# cox_weight=coxph(Surv(time, status) ~ ns(weight, df=3), data = data)
# cox_weight=coxph(Surv(time, status) ~ rcs(weight, df=5), data = data)



cox_weight
summary(cox_weight)
#Plot (baseline survival function S0(t)):
plot(survfit(cox_weight, data=data),
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()
termplot(cox_weight, term=1, se=TRUE, col.term=1, col.se=1)



#bslines, natural splines, restricted cubic splines
# cox_weight=coxph(Surv(time, status) ~ bs(weight, df=3), data = data)
 cox_weight=coxph(Surv(time, status) ~ ns(weight, df=3), data = data)
# cox_weight=coxph(Surv(time, status) ~ rcs(weight, df=5), data = data)



cox_weight
summary(cox_weight)
#Plot (baseline survival function S0(t)):
plot(survfit(cox_weight, data=data),
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()
termplot(cox_weight, term=1, se=TRUE, col.term=1, col.se=1)



#bslines, natural splines, restricted cubic splines
# cox_weight=coxph(Surv(time, status) ~ bs(weight, df=3), data = data)
# cox_weight=coxph(Surv(time, status) ~ ns(weight, df=3), data = data)
 cox_weight=coxph(Surv(time, status) ~ rcs(weight, df=5), data = data)



cox_weight
summary(cox_weight)
#Plot (baseline survival function S0(t)):
plot(survfit(cox_weight, data=data),
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()
termplot(cox_weight, term=1, se=TRUE, col.term=1, col.se=1)
```




### 5.A)
```{r}
#3.A)DimPublisher:
cox.dimpublisher <- coxph(Surv(time, status) ~ dimpublisher, data = data)
cox.dimpublisher
summary(cox.dimpublisher)

#Plot (baseline survival function S0(t)):
plot(survfit(cox.dimpublisher, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()




mfit <- coxph(Surv(time, status) ~ pspline(dimpublisher, df=2), data=data)
mfit
plot.new()
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
abline(h=0)
```






##b) 1.B) Max_players groups
```{r}
#1.B)MaxPlayers (divide into M groups the variable max_players):
maxplayers_df=with(data, data.frame (maxplayers = c(2,4,6) ))

fit.max_players=survfit(cox.max_players, newdata = maxplayers_df)
fit.max_players
summary(fit.max_players)
 
#Plot:
plot(fit.max_players, conf.int=T,
    col=c("dodgerblue2","navy","darkmagenta"), lwd=2, lty=1,
    xlab='Time [days]', ylab='Survival Probability',
    main='Adjusted Survival Probability Plot')
grid()
legend('topright', c("Max PLayers = 2", "Max PLayers = 4", "Max PLayers = 6"),
      lty=c(1,1,1), lwd=c(2,2,2), col=c("dodgerblue2","navy","darkmagenta"))
```




##b) 2.B) Economic
```{r}
#1.B)MaxPlayers (divide into M groups the variable max_players):
cox.economic <- coxph(Surv(time, status) ~ Economic_fact, data = data)
fit.economic=survfit(cox.economic, newdata = data)
fit.economic
summary(fit.economic)
 
#Plot:
plot(fit.economic, conf.int=T,
    col=c("dodgerblue2","darkmagenta"), lwd=2, lty=1,
    xlab='Time [days]', ylab='Survival Probability',
    main='Adjusted Survival Probability Plot')
grid()
legend('topright', c("Non-Economic", "Economic"),
      lty=c(1,1), lwd=c(2,2), col=c("dodgerblue2","darkmagenta"))
```




## b) Multivariate

###All categorical variables

```{r}
# columns_of_interest <- colnames(data)[105:188]
# plot_list=list()
# for (col in columns_of_interest) {
#   covariate=data[,col]
#   fit = coxph(Surv(time, status) ~ covariate, data = data)
#   
#   # Plot
#   plot=plot(survfit(fit, data=data),col="darkorange2", lwd=2, lty=1,
#              xlab='Time [days]', ylab='Survival Probability',
#              main=paste('Baseline estimated survival probability for', col))
#   plot_list[[col]] = plot
# }
# 
# length(plot_list) #84
# 
# pdf("survival_plot_for_all_categories.pdf")
# for (i in seq_along(plot_list)) {
#   print(plot_list[[i]])
# }
# dev.off()
# file.rename("survival_plot_for_all_categories.pdf", "C:/Users/Utente/Desktop/NPS/Projects/git_clone/boardgames-nps-project/survival/cox_1_cat.pdf")
```



### All numerical variables
```{r}
# glimpse(data) #check if categorical variables are considered factors --> ok!!!!
# # #In case they are not:
# # lung$sex <- ifelse(lung$sex==1,'Male','Female')
# # lung$sex <- as.factor(lung$sex)

mod.cox=coxph(Surv(time, status) ~ maxplayers + playingtime + weight + minage + dimpublisher + Year , data = data) 
summary(mod.cox)

#Plots:
#1)Hazard ratios:
#ggforest(mod.cox, data=data) #crystal clear ahahahah

#2)Baseline survival function:
plot(survfit(mod.cox, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()



# glimpse(data) #check if categorical variables are considered factors --> ok!!!!
# # #In case they are not:
# # lung$sex <- ifelse(lung$sex==1,'Male','Female')
# # lung$sex <- as.factor(lung$sex)

mod.cox=coxph(Surv(time, status) ~ playingtime + weight + minage + dimpublisher + Year , data = data) 
summary(mod.cox)

#Plots:
#1)Hazard ratios:
#ggforest(mod.cox, data=data) #crystal clear ahahahah

#2)Baseline survival function:
plot(survfit(mod.cox, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()



# glimpse(data) #check if categorical variables are considered factors --> ok!!!!
# # #In case they are not:
# # lung$sex <- ifelse(lung$sex==1,'Male','Female')
# # lung$sex <- as.factor(lung$sex)

mod.cox=coxph(Surv(time, status) ~ pspline(playingtime, df=2) + pspline(weight, df=2) + pspline(minage, df=2) + pspline(dimpublisher, df=2) + pspline(Year, df=2) , data = data) 
summary(mod.cox)

#Plots:
#1)Hazard ratios:
#ggforest(mod.cox, data=data) #crystal clear ahahahah

#2)Baseline survival function:
plot(survfit(mod.cox, data=data), 
     col="darkorange2", lwd=2, lty=1,
     xlab='Time [days]', ylab='Survival Probability',
     main='Baseline estimated survival probability')
grid()





# # glimpse(data) #check if categorical variables are considered factors --> ok!!!!
# # # #In case they are not:
# # # lung$sex <- ifelse(lung$sex==1,'Male','Female')
# # # lung$sex <- as.factor(lung$sex)
# 
# mod.cox=coxph(Surv(time, status) ~ pspline(playingtime, df=2) + pspline(weight, df=2) + pspline(minage, df=2) + pspline(dimpublisher, df=2) + pspline(Year, df=2) + pspline(dimpublisher, df=2)*pspline(playingtime, df=2) + pspline(dimpublisher, df=2)*pspline(weight, df=2) + pspline(dimpublisher, df=2)*pspline(minage, df=2) + pspline(dimpublisher, df=2)*pspline(Year, df=2) , data = data) 
# summary(mod.cox)
# 
# #Plots:
# #1)Hazard ratios:
# #ggforest(mod.cox, data=data) #crystal clear ahahahah
# 
# #2)Baseline survival function:
# plot(survfit(mod.cox, data=data), 
#      col="darkorange2", lwd=2, lty=1,
#      xlab='Time [days]', ylab='Survival Probability',
#      main='Baseline estimated survival probability')
# grid()
```

 
### Cox model assumptions and goodness of fit

#### 1) Martingale residuals
```{r}
##1)Martingale residuals
#a)
plot(predict(mod.cox), residuals(mod.cox, type='martingale'),
     xlab='Fitted values', ylab='Martingale residuals', main='Residual Plot', las=1)
# Add a line for residual=0
abline(h=0, col='red')
# Fit a smoother for the points
lines(smooth.spline(predict(mod.cox), residuals(mod.cox, type='martingale')), col='blue')

#b)
ggcoxdiagnostics(mod.cox, type = "martingale")
# * A value of martingale residuals near 1 represents individuals that “died too soon”,
# * A large negative value corresponds to individuals that “lived too long”.
```


#### 2) Deviance residuals

```{r}
##2)Deviance residuals
ggcoxdiagnostics(mod.cox, type = "deviance")
# -   Positive values correspond to individuals that "died too soon" compared to expected survival times.
# -   Negative values correspond to individual that "lived too long".
# -   Very large or small values are outliers, which are poorly predicted by the model.
```


#### 3) Schoenfeld residuals

```{r}
##3)Schoenfeld residuals
ggcoxdiagnostics(mod.cox, type = "schoenfeld")
# (. They should be flat, centered about zero.)
# (. They are independent of time.)
#  . A plot that shows a non-random pattern against time is evidence of violation of the PH assumption (the HR for 2 fixed covariate vectors is costant over time).
```


#### 4) Log-negative-log-KM (for categorical variables)

```{r}
# ##4)Log-negative-log-KM (ONLY FOR CATEGORICAL VARIABLES!!!!)
# #1)Economic:
# economic.km <- survfit(Surv(time, status) ~ Economic_fact, data = data)
# 
# #Plot:
# plot(economic.km, fun='cloglog', 
#      col=c("deeppink2","dodgerblue2"), lwd=2, lty=1,
#      ylab="log(-log(Survival Probability))")
# grid()
# legend('topleft', c("Non-Economic", "Economic"),
#        lty=c(1,1), lwd=c(2,2), col=c("deeppink2","dodgerblue2"))
# # If the curves seem to be parallel --> PH assumption seems to be satisfied for this covariate
```


#### 5) Quantitative strategies (test for HP)

```{r}
##5)Quantitative strategies (test for HP)

# Test for PH using scaled Schoenfeld test for PH
# -   H0: Hazards are proportional
# -   H1: Hazards are NOT proportional

test.ph=cox.zph(mod.cox)
test.ph

#Plot (scaled Schoenfeld residuals):
# #a)
# par(mfrow=c(2,2))
# for(i in 1:4){
#   plot(test.ph[i])
#   abline(h=0, col='red')
# }
# 
# #b)
# ggcoxdiagnostics(mod.cox, type = "scaledsch")
```




# STRATIFIED COX MODEL

## All numerical variables

```{r}
##DA FARE----

mod.cox.strata=coxph(Surv(time, status) ~ maxplayers + strata(playingtime) + weight + strata(minage) + strata(dimpublisher) + strata(Year), data =data) #metti le variabili che vuoi, strata(covariata)--> per le covariate che non rispettano la HP assumption
summary(mod.cox.strata)

#Test for PH asumption:
test.ph.strata = cox.zph(mod.cox.strata)
test.ph.strata
```



# urgenteeeeeeeeeeeeeeeee